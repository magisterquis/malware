package main

/*
 * pmbuf.go
 * Buffer protocol messages
 * By J. Stuart McMurray
 * Created 20160727
 * Last Modified 20160727
 */

/* PMBufAdd adds line to the Protocol Message Buffer */
func (s *Server) PMBufAdd(line string) {
	s.plock.Lock()
	defer s.plock.Unlock()
	/* If the buffer's not full, just add it */
	if len(s.pmbuf) != cap(s.pmbuf) {
		s.pmbuf = append(s.pmbuf, line)
		s.pmnxt = len(s.pmbuf) % cap(s.pmbuf)
		return
	}

	/* Stick it in, update next pointer */
	s.pmbuf[s.pmnxt] = line
	s.pmnxt = (s.pmnxt + 1) % len(s.pmbuf)
}

/* PMBufGet returns a copy of the contents of the Protocol Message Buffer, in
order */
func (s *Server) PMBufGet() []string {
	s.plock.Lock()
	defer s.plock.Unlock()
	b := make([]string, len(s.pmbuf)) /* Buffer to copy the buffer into */
	/* Copy buffer */
	var cur int
	for i := range b {
		cur = (i + s.pmnxt) % len(s.pmbuf)
		b[i] = s.pmbuf[cur]
	}
	return b
}
