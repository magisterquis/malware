package main

/*
 * udp.go
 * Sends commands to pasvmon via udp
 * By J. Stuart McMurray
 * Created 20160227
 * Last Modified 20160227
 */

import (
	"log"
	"net"
)

/* udp reads lines from stdin and sends them to the target at raddr. */
func udp(laddr, raddr string, stdin <-chan string) {
	var err error
	/* Make a UDP "connection" */
	la := resolveUDP(laddr)
	ra := resolveUDP(raddr)
	c, err := net.DialUDP("udp", la, ra)
	if nil != err {
		log.Fatalf(
			"Unable to \"connect\" to %v from %v: %v",
			la,
			ra,
			err,
		)
	}
	log.Printf("\"Connected\" %v -> %v", c.LocalAddr(), c.RemoteAddr())

	/* Send lines from stdin to it */
	var n int
	for l := range stdin {
		n, err = c.Write([]byte(l))
		if nil != err {
			log.Fatalf("Send error: %v", err)
		}
		log.Printf("Sent %v bytes", n)
	}
}

/* resolveUDP resolves addr into a UDP address, or terminates the program. */
func resolveUDP(addr string) *net.UDPAddr {
	a, err := net.ResolveUDPAddr("udp", addr)
	if nil != err {
		log.Fatalf(
			"Unable to resolve UDP address %q: %v",
			addr,
			err,
		)
	}
	return a
}
