#!/bin/sh
#
# build.sh
# Build malware
# By J. Stuart McMurray
# Created 20160221
# Last Modified 20160223

set -e

# Maybe clean
CLEAN="no"
if [ "clean" == "$1" ]; then
        CLEAN="yes"
fi

# Build go binaries
for d in *; do
        # Only care about directories
        if ! [ -d "$d" ]; then
                continue
        fi

        # If there's a build.sh in that directory, use it
        if [ -x "$d/build.sh" ]; then
                (
                cd "$d"
                ./build.sh "$@"
                )
                continue
        fi

        # If there's go source, build it
        #TODO: Move to function, check more gracefully
        HAVE=0
        for f in ./$d/*.go; do
                if [ -f "$f" ]; then
                        HAVE=1
                        break
                fi
        done
        if [ "0" == "$HAVE" ]; then
                continue
        fi
        # Make the go binary in that directory
        (
        cd "$d"
        for GOOS in windows linux openbsd darwin; do
                for GOARCH in 386 amd64; do
                        export GOOS GOARCH
                        N="$d.$GOOS.$GOARCH"
                        # Windows is special...
                        if [ "windows" == $GOOS ]; then
                                N=$N.exe
                        fi
                        # Remove the binary if we're cleaning
                        if [ "yes" == "$CLEAN" ]; then
                                # And if it exists
                                if [ -f $N ]; then
                                        rm "$N"
                                        echo "Removed $N"
                                fi
                        else # Build if not
                                go build -o "$N"
                                (cd .. && ls -l "$d/$N")
                        fi
                done
        done
        )
done
